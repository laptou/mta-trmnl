---
import Layout from "../../layouts/Layout.astro";
import type { TrainArrival } from "../../util/mta";
import {
    getAllLines,
    getStationsForLine,
    getUpcomingArrivals,
    type Station,
} from "../../util/mta";

const { id: lineId } = Astro.params;
if (!lineId) throw new Error("impossible");

const lines = await getAllLines();
const line = lines.find((r) => r.routeId === lineId);
if (!line) {
    console.log("line not found");
    return Astro.redirect("/404");
}

console.log("getting stations for line");
const stations = await getStationsForLine(lineId);

const stationsWithArrivals = await Promise.all(
    stations
        .filter((s) => !s.parentStation)
        .map(async (station) => {
            let arrivals = await getUpcomingArrivals(station.stopId, lineId, 6);
            arrivals = arrivals.filter((a) => a.line === line.routeId);

            return { station, arrivals };
        }),
);
---

<Layout>
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <a href="/" class="text-blue-500 hover:underline"
                >&larr; Back to Lines</a
            >
        </div>

        <h1
            class="text-4xl font-bold mb-8"
            style={`color: #${line.routeColor || "000000"}`}
        >
            Line {line.routeShortName}
        </h1>

        <div class="grid gap-8">
            {
                stationsWithArrivals.map(({ station, arrivals }) => {
                    const arrivalsNorth = arrivals.filter(
                        (a) => a.stopId === station.stopId + "N",
                    );
                    const arrivalsSouth = arrivals.filter(
                        (a) => a.stopId === station.stopId + "S",
                    );

                    return (
                        <div class="border rounded-lg p-6">
                            <a
                                href={`/station/${station.stopId}`}
                                class="block"
                            >
                                <h2 class="text-2xl font-bold mb-4 hover:text-blue-500">
                                    {station.stopName}
                                </h2>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <h3 class="font-semibold mb-2">
                                            Uptown
                                        </h3>
                                        {arrivalsNorth.length > 0 ? (
                                            <ul class="space-y-1">
                                                {arrivalsNorth.map(
                                                    (arrival) => (
                                                        <li>
                                                            {arrival.line}{" "}
                                                            {arrival.departureTime.toString()}
                                                        </li>
                                                    ),
                                                )}
                                            </ul>
                                        ) : (
                                            <p class="text-gray-500">
                                                No upcoming{" "}
                                                {line.routeShortName} trains
                                            </p>
                                        )}
                                    </div>
                                    <div>
                                        <h3 class="font-semibold mb-2">
                                            Downtown
                                        </h3>
                                        {arrivalsSouth.length > 0 ? (
                                            <ul class="space-y-1">
                                                {arrivalsSouth.map(
                                                    (arrival) => (
                                                        <li>
                                                            {arrival.line}{" "}
                                                            {arrival.departureTime.toString()}
                                                        </li>
                                                    ),
                                                )}
                                            </ul>
                                        ) : (
                                            <p class="text-gray-500">
                                                No upcoming{" "}
                                                {line.routeShortName} trains
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </a>
                        </div>
                    );
                })
            }
        </div>
    </div>
</Layout>
